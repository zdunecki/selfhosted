app: openreplay
description: OpenReplay - Open-source session replay and product analytics
os: ubuntu-22-04-x64
min_spec:
    cpu: 4
    ram: 8gib
    disk: 80gib
providers: 
  # - aws IN THE FUTURE
  # - azure IN THE FUTURE
  # - gcp IN THE FUTURE
  - digitalocean
  # - ovh IN THE FUTURE
  # - scaleway IN THE FUTURE

steps:
  - name: Install on machine
    in: machine
    run: |
      cloud-init status --wait || true
      apt-get update -y
      DEBIAN_FRONTEND=noninteractive apt-get upgrade -y
      sudo wget https://raw.githubusercontent.com/openreplay/openreplay/main/scripts/helmcharts/openreplay-cli -O /bin/openreplay 
      sudo chmod +x /bin/openreplay
      openreplay -i {opts.Domain}

  - name: Verify status
    in: machine
    log: "Checking OpenReplay status"
    run: |
      openreplay -s || true

  - name: Own SSL
    in: machine
    if: opts.SSLPrivateKeyFile || opts.SSLCertificateCrt
    run: |
      kubectl \
      create \
      secret \
      tls \
      openreplay-ssl -n app --key="{opts.SSLPrivateKeyFile}" --cert="{opts.SSLCertificateCrt}"

  - name: SSL
    if: opts.SSL
    in: machine
    sleep: 30s
    run: |
      cat >> /var/lib/openreplay/vars.yaml << 'EOF'
      # SSL Configuration - Auto-generated by selfhost-installer
      ssl:
        enabled: true
        email: "{opts.Email}"
        domain: "{opts.Domain}"
        config:
          createRootCA: true
          createNamespace: false
          issuerName: "letsencrypt-prod"
      EOF
      cd /var/lib/openreplay/openreplay/scripts/helmcharts && bash certmanager.sh "{opts.Email}" "{opts.Domain}"
      kubectl patch ingress -n app frontend --type='json' -p='[
        {"op": "add", "path": "/spec/tls", "value": [{"hosts": ["{opts.Domain}"], "secretName": "{opts.Domain}-tls"}]}
      ]' || true

  # - name: Abc
  #   if: opts.HttpToHttpsRedirection
  #   run: |
  #     cat /var/lib/openreplay/vars.yaml | comment 'ingress-nginx'

  - name: Restart
    in: machine
    run: |
      openreplay -R
